---
title: "RMD.Proyecto.Daniel.Solano"
author: "Daniel Solano"
date: '2023-03-19'
output: html_document
---

```{r, include = FALSE}
rm(list=ls())

library(mapview)
library(raster)
library(maptools)
library(sp)
library(sf)
library(rgdal)
library(dismo)
library(spam)
library(rworldmap)
library(rworldxtra)
library(jsonlite)
library(rgeos)
library(mapSpain)
library(ggmap)
library(ggplot2)
library(maps)
library(mapdata)
library(marmap)
library(mapproj)
library(slippymath)
library(ggspatial)
library(tidyterra)
```

## Proyecto

Este proyecto consiste en la búsqueda de solapamiento de nichos entre diferentes grupos de individuos según su especie y sexo, en base a datos correspondientes a visitas de puntos concretos dentro de la zona de estudio de Silwood Park. A partir de los datos proporcionados se obtiene un segundo data.frame con los datos de visitas agregados:

```{r datos, echo=FALSE}
datos1 <- read.csv(file="~/Temporada 2022-2023/Asignaturas/2o cuatrimestre/Ciencia de datos/script/data/dataAurelio.csv",
         sep=";")
datos.clean <- subset(datos1, select=c("x.coord.1m", "y.coord.1m", "Species", "Sex", "day", "month", "year", "visit"))
datos.clean.agg <-
  aggregate(cbind(visit) ~   x.coord.1m +y.coord.1m+ Species +Sex +year +month, data = datos.clean, sum)
```

### Diseño del array

Antes de calcular las diferentes áreas de solapamiento se establecen las medidas del array:

```{r datos1, echo=FALSE}
subsets = expand.grid(Species1 = c("AS","AF","CG"),
                      Sex1 = c("F", "M"),
                      Species2 = c("AS","AF","CG"),
                      Sex2 = c("F", "M")
                     )
str(subsets)
subsets = subsets[-c(1,8,15,22,29,36),]
subsets$Species1 = as.character(subsets$Species1)
subsets$Species2 = as.character(subsets$Species2)
subsets$Sex1 = as.character(subsets$Sex1)
subsets$Sex2 = as.character(subsets$Sex2)


nyear = 10:13
nmonth = 1:12
nsubs = nrow(subsets)

tabla.solapamientos = array(NA, dim = c(12,5,4,30)) 
```

### Cálculo de los datos

```{r datos2, echo=FALSE}
for (i in nyear) {#i=12
  
  datos.clean.agg.i = subset (datos.clean.agg, year == i)
  year.i = which(nyear==i)
  
  
  for (j in nmonth) { #j=1
    
    datos.clean.agg.i.j = subset(datos.clean.agg.i, month == j)
    
    
    
    if(nrow(datos.clean.agg.i.j)>0){
      for (k in 1:nsubs) { #k=3
      
      print(paste(i,j,k))
      
      if(paste(i,j,k) != "11 3 26" & paste(i,j,k) != "11 10 9"){  
        
      datos.clean.agg.i.j.k.1 = subset(datos.clean.agg.i.j, Species == subsets[k,1] & Sex == subsets[k,2])
      datos.clean.agg.i.j.k.2 = subset(datos.clean.agg.i.j, Species == subsets[k,3] & Sex == subsets[k,4])
      
      
      
      if(nrow(datos.clean.agg.i.j.k.1) > 0 & nrow(datos.clean.agg.i.j.k.2) > 0){
        
     # datos.clean.agg.i.j.k.1 <- arrange(datos.clean.agg.i.j.k.1, x.coord.1m)
      datos.clean.agg.i.j.k.1[order(datos.clean.agg.i.j.k.1[,"x.coord.1m"], 
                                    datos.clean.agg.i.j.k.1[,"y.coord.1m"]),]
        
      rango.k.1.ch <- chull(datos.clean.agg.i.j.k.1[,c("x.coord.1m", "y.coord.1m")])
      rango.k.1.ch <- c(rango.k.1.ch, rango.k.1.ch[1])
      
      #plot(datos.clean.agg.i.j.k.2[,"x.coord.1m"],datos.clean.agg.i.j.k.2[,"y.coord.1m"])
      #datos.clean.agg.i.j.k.2 <- arrange(datos.clean.agg.i.j.k.2, x.coord.1m)
      datos.clean.agg.i.j.k.2[
        order(datos.clean.agg.i.j.k.2[,"x.coord.1m"], datos.clean.agg.i.j.k.2[,"y.coord.1m"]),
      ]
      rango.k.2.ch <- chull(datos.clean.agg.i.j.k.2[,c("x.coord.1m", "y.coord.1m")])
      rango.k.2.ch <- c(rango.k.1.ch, rango.k.2.ch[1])
      
      #polygon(datos.clean.agg.i.j.k.1[rango.k.1.ch, c("x.coord.1m", "y.coord.1m")])
      #polygon(datos.clean.agg.i.j.k.2[rango.k.2.ch, c("x.coord.1m", "y.coord.1m")])
      
      coords.k.1 <- as.data.frame(datos.clean.agg.i.j.k.1[rango.k.1.ch,c("x.coord.1m", "y.coord.1m")])
      coords.k.1 <- subset(coords.k.1,!is.na(x.coord.1m))
      p.k.1 = Polygon(coords.k.1)
      ps.k.1 = Polygons(list(p.k.1),1)
      sps.k.1 = SpatialPolygons(list(ps.k.1))
      convex.k.1 <- st_as_sf(sps.k.1, coords = c("x.coord.1m", "y.coord.1m"), crs = 4326)
      
      coords.k.2 <- as.data.frame(datos.clean.agg.i.j.k.2[rango.k.2.ch,c("x.coord.1m", "y.coord.1m")])
      coords.k.2 <- subset(coords.k.2,!is.na(x.coord.1m))
      p.k.2 = Polygon(coords.k.2)
      ps.k.2 = Polygons(list(p.k.2),1)
      sps.k.2 = SpatialPolygons(list(ps.k.2))
      convex.k.2 <- st_as_sf(sps.k.2, coords = c("x.coord.1m", "y.coord.1m"), crs = 4326)
      
      #e=simpleError("testerror")
      #is.error(tryCatch(e))
      #tryCatch(st_intersection (convex.k.1, convex.k.2))
      
      
      if (st_is_valid(convex.k.1) == FALSE | st_is_valid(convex.k.2) == FALSE) {
        
      convex.k.1 = st_make_valid(convex.k.1)
      convex.k.2 = st_make_valid(convex.k.2) 
      
      }
      
        
      #plot(convex.k.1)
      #plot(convex.k.2, add=T,col="red")
      #plot(convex.k.2, add=F,col="red")
      
      
      k.1k.2_intersect <- st_intersection (convex.k.1, convex.k.2)
      
      area.k1 = st_area(convex.k.1)
      area.k2 = st_area(convex.k.2)
      
      if (length(k.1k.2_intersect$geometry) == 0) {
        tabla.solapamientos[j,1,year.i,k] = area.k1
        tabla.solapamientos[j,2,year.i,k] = area.k1.k2 = 0
        tabla.solapamientos[j,3,year.i,k] = area.k1.k2.total = (area.k1 - area.k1.k2) + (area.k1 - area.k1.k2) + area.k1.k2
        tabla.solapamientos[j,4,year.i,k] = prop.solapamiento.k1.k2 = area.k1.k2/area.k1.k2.total*100
        tabla.solapamientos[j,5,year.i,k] = prop.solapamiento.k = area.k1.k2/area.k1*100
        
        
      } else {
        
      tabla.solapamientos[j,1,year.i,k] = area.k1
      tabla.solapamientos[j,2,year.i,k] = area.k1.k2 = st_area(k.1k.2_intersect)
      tabla.solapamientos[j,3,year.i,k] = area.k1.k2.total = (area.k1 - area.k1.k2) + (area.k1 - area.k1.k2) + area.k1.k2
      tabla.solapamientos[j,4,year.i,k] = prop.solapamiento.k1.k2 = area.k1.k2/area.k1.k2.total*100
      tabla.solapamientos[j,5,year.i,k] = prop.solapamiento.k = area.k1.k2/area.k1*100
      }
        
      }
      }
    }}
  }
}

```
